%package gemset
Summary: %{product_summary} Gemset
BuildRequires: /usr/bin/pathfix.py

Requires: cifs-utils
Requires: libpq
Requires: libcurl
Requires: librdkafka
Requires: libssh2
Requires: libxml2
Requires: libxslt
Requires: nfs-utils
Requires: openscap-scanner
Requires: openssl
Requires: nodejs
Requires: sqlite

%ifarch x86_64
Requires: wmi
%endif

# For Miq IPMI (gems-pending)
Requires: OpenIPMI
Requires: freeipmi
Requires: ipmitool

# For Lenovo
Requires: python3-pylxca

# For Nuage
Requires: cyrus-sasl
Requires: cyrus-sasl-plain
Requires: python3-vspk
Requires: qpid-proton-c

# For RHV
Requires: ovirt-ansible-collection

# For IMS
Requires: v2v-conversion-host-ansible

# For Appliance Console
Requires: libsodium-devel
Requires: network-scripts

# For scanning
Requires: glusterfs-fuse

%description gemset
%{product_summary} Gemset

%post gemset
# Remove any old systemd unit files
provider_worker_types="event_catcher metrics_collector refresh operations"
provider_types="amazon_cloud_manager ansible_tower_automation_manager azure_cloud_manager autosde_storage_manager azure_stack_cloud_manager azure_stack_network_manager foreman_configuration_manager google_cloud_manager google_network_manager ibm_cloud_vpc_cloud_manager ibm_cloud_power_virtual_servers_cloud_manager ibm_terraform_configuration_manager kubernetes_container_manager kubernetes_monitoring_manager kubevirt_infra_manager lenovo_physical_infra_manager microsoft_infra_manager nsxt_network_manager nuage_network_manager openshift_container_manager openshift_monitoring_manager openstack_cloud_manager openstack_infra_manager openstack_network_manager openstack_storage_manager_cinder_manager amazon_storage_manager_s3 redhat_infra_manager redhat_network_manager redfish_physical_infra_manager vmware_cloud_manager vmware_infra_manager"

files=""
for provider_type in ${provider_types}
do
  for provider_worker_type in ${provider_worker_types}
  do
    files+="${provider_type}_${provider_worker_type} "
  done
done
files+="amazon_agent_coordinator"

for file in ${files}
do
  [[ -e /etc/systemd/system/${file}.target ]] && rm /etc/systemd/system/${file}.target
  [[ -e /etc/systemd/system/${file}@.service ]] && rm /etc/systemd/system/${file}@.service
  [[ -e /etc/systemd/system/${file}@*.service ]] && rm /etc/systemd/system/${file}@*.service
  [[ -e /etc/systemd/system/${file}@*.service.d/override.conf ]] && rm /etc/systemd/system/${file}@*.service.d/override.conf
  [[ -e /etc/systemd/system/${file}@*.service.d ]] && rm -r /etc/systemd/system/${file}@*.service.d
done

%files gemset
%defattr(-,root,root,775)
%dir %{gemset_root}
%{gemset_root}/bin
%{gemset_root}/build_info
%{gemset_root}/bundler
%{gemset_root}/cache
%{gemset_root}/doc
%{gemset_root}/extensions
%{gemset_root}/gems
%{gemset_root}/specifications
%{gemset_root}/vmdb
%{gemset_root}/enable
%{_prefix}/lib/systemd/system/manageiq-providers*
%{manifest_root}/gem_manifest.csv
