%global ruby_min_version 3.3

%package core
Summary:  %{product_summary} Core

Requires: ruby >= %{ruby_min_version}
# Include weak dependencies of Ruby that we actually need
Requires: ruby-default-gems >= %{ruby_min_version}
Requires: rubygems

Requires: %{name}-gemset = %{version}-%{release}
Requires: %{name}-ansible-venv = %{version}-%{release}

Requires: git
Requires: net-snmp
Requires: net-snmp-libs
Requires: net-snmp-utils
Requires: socat

# rpm %pre uses id (appliance or containers)
Requires: (coreutils or coreutils-single)

# rpm %pre uses useradd
Requires: shadow-utils

%description core
%{product_summary} Core

%pre core
# ensure this user exists (build and upgrade)
/usr/bin/id manageiq > /dev/null 2>&1 || /usr/sbin/useradd --system --create-home manageiq
# create a manageiq home directory if it doesn't exist
mkdir -p /home/manageiq && chown manageiq:manageiq /home/manageiq

%posttrans core
# 'bin' needs to be copied, not symlinked
[[ -e /var/www/miq/vmdb/bin ]] && rm -rf /var/www/miq/vmdb/bin
cp -a %{gemset_root}/vmdb/bin /var/www/miq/vmdb/bin

files=".bundle Gemfile.lock"
for file in ${files}
do
  [[ -e /var/www/miq/vmdb/${file} ]] && rm -rf /var/www/miq/vmdb/${file}
  ln -s %{gemset_root}/vmdb/${file} /var/www/miq/vmdb/${file}
done

%post core
# These directories contain files not owned by this rpm.
#  For upgrades, ensure the files have the correct group privs
#  so root and manageiq users can read them.
[ -e %{app_root}/certs/v2_key ] && %{__chown} manageiq.manageiq %{app_root}/certs/v2_key
[ -e %{app_root}/certs/v2_key ] && %{__chmod} o-rw %{app_root}/certs/v2_key
[ -e %{app_root}/certs/server.cer ] && %{__chmod} g+r %{app_root}/certs/server.cer
[ -e %{app_root}/certs/server.cer.key ] && %{__chmod} g+r %{app_root}/certs/server.cer.key

%{__chown} -R manageiq.manageiq %{app_root}/log
%{__chmod} -R o-rw %{app_root}/log

%{__chown} -R manageiq.manageiq %{app_root}/tmp/pids
%{__chmod} -R o-rw %{app_root}/tmp/pids

%{__chown} -R manageiq.manageiq %{app_root}/data

# Set SELinux contexts to allow podman containers to run from /var/lib/manageiq/containers/storage
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay2(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay2-images(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay2-layers(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay-layers(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/overlay-images(/.*)?'
semanage fcontext --add --type container_ro_file_t '%{manageiq_var_lib_root}/containers/storage/artifacts(/.*)?'
semanage fcontext --add --type container_file_t    '%{manageiq_var_lib_root}/containers/storage/volumes/[^/]*/.*'
semanage fcontext --add --type container_var_lib_t '%{manageiq_var_lib_root}/containers(/.*)?'
restorecon -RvF %{manageiq_var_lib_root}/containers/

%files core
%defattr(-,root,root,-)
%{app_root}/AUTHORS
%{app_root}/CHANGELOG.md
%{app_root}/CONTRIBUTING.md
%{app_root}/Dockerfile
%{app_root}/Gemfile
%{app_root}/LICENSE.txt
%{app_root}/NOTICE.txt
%{app_root}/Procfile.example
%{app_root}/README.md
%{app_root}/Rakefile
%{app_root}/VERSION
%{app_root}/app
%{app_root}/bin
%{app_root}/bundler.d
%attr(-,manageiq,manageiq) %{app_root}/certs
%attr(-,manageiq,manageiq) %{app_root}/config
%{app_root}/config.ru
%{app_root}/container-assets
%{app_root}/content
%attr(-,manageiq,manageiq) %{app_root}/data
%{app_root}/db
%{app_root}/lib
%{app_root}/locale
%attr(-,manageiq,manageiq) %{app_root}/log
%{app_root}/product
%{app_root}/public
%{app_root}/script
%{app_root}/spec
%{app_root}/systemd
%attr(-,manageiq,manageiq) %{app_root}/tmp
%{app_root}/tools

%config(noreplace) %{app_root}/config/cable.yml
%exclude %{app_root}/public/pictures
%exclude %{app_root}/public/assets
%exclude %{app_root}/public/packs
%exclude %{app_root}/public/ui
%exclude %{app_root}/public/upload
%exclude %{app_root}/log/apache
%{manifest_root}/BUILD
%{manifest_root}/BUILD_RPM_BUILD
/usr/share/ansible/roles/
%{manageiq_var_lib_root}/containers
%attr(-,manageiq,manageiq) %{manageiq_var_lib_root}/containers
